
### Vue 2 的 Diff 算法概述

Vue 2 的 diff 算法主要关注的是如何高效地更新 DOM，而不是实现一个完全通用的 diff 算法。Vue 采用了几个关键性的优化策略来提高 diff 的效率：

1. **双端队列**：Vue 使用一个双端队列（Deque）来跟踪需要更新的节点。
2. **元素类型检查**：Vue 仅在同一类型的元素之间进行 diff，不同类型的元素直接替换。
3. **属性和事件更新**：Vue 会更新元素的属性和事件绑定。
4. **文本节点的比较**：文本节点仅比较文本内容。
5. **组件的更新**：Vue 会区分普通 DOM 元素和组件，并对组件进行特定的更新处理。
6. **懒惰更新**：Vue 采用了异步更新策略，将多个变更合并到一次渲染中。

### Vue 2 的 Diff 算法步骤

Vue 2 的 diff 算法主要包括以下几个步骤：


1. **旧虚拟 DOM 树与新虚拟 DOM 树的比较**：
	- 只会同层比较，不进行跨层比较
    - Vue 使用双端队列来跟踪需要更新的节点，并进行以下比较：
        - **元素类型（比较标签）**：如果旧节点和新节点的类型不同（如 `<div>` 变为 `<span>`），则直接替换整个节点。
        - **元素 key（比较key）**：如果节点有 key，Vue 会根据 key 来识别节点，以确保正确的复用和更新。
        - **元素属性**：如果元素类型相同，则比较属性和事件绑定，只更新有变化的部分。
        - **文本节点**：如果节点是文本节点，直接比较文本内容。
        - **子节点**：递归比较子节点。
2. **子节点的 diff**：
    - 对于子节点，Vue 会进行如下处理：
        - **双端队列**：使用双端队列来跟踪需要比较的节点。
        - **元素类型和 key**：根据元素类型和 key 来决定是否需要移动或替换节点。
        - **元素位置**：Vue 会尽量保持元素的位置不变，以避免不必要的 DOM 操作。



### 为什么不应该使用数组索引作为 `key` 的几个主要原因：

1. 数据变动时的不稳定性

当列表中的项发生变化时（例如添加、删除或排序），使用索引作为 `key` 会导致不稳定的情况。具体来说：

- **添加或删除项**：如果在列表中添加或删除项，那么之后的所有项的索引都会发生变化。这会导致 Vue 误以为之前的所有项都是新的，从而导致不必要的重新渲染和更新。
- **排序或重新排序**：如果列表项被重新排序，那么所有项的索引也会发生变化，这同样会导致不必要的重新渲染。

2. 无法正确复用元素

使用索引作为 `key` 时，当列表项的位置发生变化时，Vue 无法正确地复用原有的 DOM 节点。这可能导致不必要的重新渲染，降低了性能。



### Vue 3 的 Diff 算法细节

Vue 3 的 diff 算法主要包括以下几个方面：

1. **元素类型检查**：
    - 与 Vue 2 类似，Vue 3 也会检查元素类型是否相同。如果类型不同，则直接替换整个节点。
2. **元素 key 检查**：
    - Vue 3 继续使用 `key` 来识别节点，以确保正确的复用和更新。
    - 如果使用索引作为 `key`，Vue 3 会发出警告，提示开发者使用具有唯一性的 `key`。
3. **属性和事件更新**：
    - Vue 3 会更新元素的属性和事件绑定，仅更新有变化的部分。
4. **文本节点比较**：
    - Vue 3 仅比较文本内容，如果内容不同则更新文本。
5. **子节点 diff**：
	- 头和头比较
	- 尾和尾比较
	- 剩下的没有比较过的节点去跟旧的找到不存在的，就是要新增的。
	- 然后使用最长递增子序列，把节点剔除，剩下的做移动、新增、删除就行了。
7. **组件更新**：
    - Vue 3 对组件的更新也进行了优化，通过 `setup` 函数来分离逻辑和渲染，使得组件的更新更加高效。





### vue3和vue2的diff算法区别

- `Vue2`使用的是`基于递归的双指针的diff算法`，而`Vue3`使用的是`基于数组的动态规划的diff算法`， Vue 3的算法效率更高，因为它使用了一些优化技巧，例如按需更新、静态标记等。
	- **静态标记**：变化的之后直接找标记进行比较，已经标记为静态节点的元素不会参与diff比较，减轻diff

- Vue3的diff算法相比Vue2更加高效，并且`新增的静态提升优化方式`可以进一步提升渲染性能。 在计算key值不同时，Vue2会采用首尾两端比较的方法，而Vue3则采用了更高效的“Map”数据结构。 在节点移动时，Vue2通过splice函数进行数组操作，而Vue3则采用了更轻量级的移动节点算法。 Vue2使用双向指针来进行虚拟DOM的比较，而Vue3则使用了单向链表的方式。

- `Vue3.x 的 diff 算法在核心思路上都是基于同层比较和节点复用的策略`，但Vue3.x在实现细节和性能优化上做了更多的工作，使得其渲染性能更加出色。 在实际使用中，Vue3.x 的性能提升对于大型应用或需要频繁更新 DOM 的场景尤为明显。
